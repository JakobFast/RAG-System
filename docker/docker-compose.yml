version: '3.8'

# ===========================================
# RAG System Docker Compose
# ===========================================
# Deploy this on your NAS
# 
# Usage:
#   1. Copy this file to your NAS
#   2. Create .env file with your API keys
#   3. Run: docker-compose up -d

services:
  # ===========================================
  # QDRANT - Vector Database
  # ===========================================
  # Stores embeddings (numerical representations of text)
  # Dashboard: http://NAS-IP:6333/dashboard
  qdrant:
    image: qdrant/qdrant:latest
    container_name: rag-qdrant
    ports:
      - "6333:6333"    # REST API
      - "6334:6334"    # gRPC (faster protocol)
    volumes:
      - ./qdrant_data:/qdrant/storage
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # POSTGRESQL - Relational Database
  # ===========================================
  # Stores document metadata, chunk text, relationships
  postgres:
    image: postgres:16
    container_name: rag-postgres
    environment:
      POSTGRES_DB: rag_system
      POSTGRES_USER: rag_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rag_user -d rag_system"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # LITELLM - LLM Proxy
  # ===========================================
  # Unified API for OpenAI, Anthropic, and other LLMs
  # API: http://NAS-IP:4000
  # Docs: http://NAS-IP:4000/docs
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: rag-litellm
    ports:
      - "4000:4000"
    volumes:
      - ./litellm_config.yaml:/app/config.yaml
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY}
    command: ["--config", "/app/config.yaml"]
    restart: unless-stopped
    depends_on:
      - postgres

  # ===========================================
  # OPEN-WEBUI - Chat Interface
  # ===========================================
  # Beautiful chat UI that connects to LiteLLM
  # UI: http://NAS-IP:3000
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: rag-openwebui
    ports:
      - "3000:8080"
    environment:
      - OPENAI_API_BASE_URL=http://litellm:4000/v1
      - OPENAI_API_KEY=${LITELLM_MASTER_KEY:-dummy-key}
      - WEBUI_AUTH=true
    volumes:
      - ./openwebui_data:/app/backend/data
    depends_on:
      - litellm
    restart: unless-stopped

networks:
  default:
    name: rag-network
